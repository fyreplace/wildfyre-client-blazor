@inherits LayoutComponentBase
@inject NavigationManager navigator
@inject IHistoryService history
@inject ILocalStorageService localStorage
@inject IJSRuntime javascript
@inject IAuthorService authorService

<div class="page @CssClass">
    <SideNavigation Destinations=@destinations />
    <BottomNavigation Destinations=@destinations />
    <div class="main">
        @if (isAuthenticated)
        {
            @Body
        }
        else
        {
            <Login />
        }
    </div>
</div>

@code
{
    private Destination[] destinations = new Destination[] {
        new Destination() {
            Route = "feed",
            Text = "Feed",
            Icon = __builder => { <FeedIcon /> },
        },
        new Destination() {
            Route = "notifications",
            Text = "Notifications",
            Icon = __builder => { <NotificationsIcon /> },
        },
        new Destination() {
            Route = "archive",
            Text = "Archive",
            Icon = __builder => { <ArchiveIcon /> },
        },
        new Destination() {
            Route = "drafts",
            Text = "Drafts",
            Icon = __builder => { <DraftsIcon /> },
        },
        new Destination() {
            Route = "settings",
            Text = "Settings",
            Icon = __builder => { <SettingsIcon /> },
        },
    };
    private bool isAuthenticated;
    private string CssClass => isAuthenticated ? "" : "-full-screen";

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        if (navigator.ToBaseRelativePath(navigator.Uri) == "")
        {
            await javascript.InvokeVoidAsync("window.location.replace", "feed");
        }

        localStorage.Changed += OnLocalStorageChanged;
        // Trigger post-login process
        var token = await localStorage.GetItemAsStringAsync("auth.token") ?? "";
        await localStorage.SetItemAsync("auth.token", token);
    }

    private async void OnLocalStorageChanged(object sender, Blazored.LocalStorage.ChangedEventArgs args)
    {
        if (args.Key == "auth.token")
        {
            var value = args.NewValue?.ToString() ?? "";
            isAuthenticated = value.Length > 0;

            if (isAuthenticated)
            {
                var self = await authorService.GetSelf();
                await localStorage.SetItemAsync("author.self", self);
            }
            else
            {
                await localStorage.RemoveItemAsync("author.self");
            }

            StateHasChanged();
        }
    }
}
